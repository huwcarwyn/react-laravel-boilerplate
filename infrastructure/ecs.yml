Description: >
  Deploy an ECS cluster onto an EC2 instance

Parameters:
    EnvironmentName:
        Description: Prefix for the resources we will create
        Type: String

    InstanceType: 
        Description: Which instance type should we use to build the ECS cluster?
        Type: String
        Default: c4.large

    ClusterSize:
        Description: How many ECS hosts do you want to initially deploy?
        Type: Number
        Default: 4

    LBCertificateArn:
        Description: AWS ARN of the SSL certificate to be used by the ALB
        Type: String

    S3BucketName:
        Description: Name of a S3 Bucket to be granted access to
        Type: String

Mappings:
    AWSRegionToAMI:
        us-east-2:
            AMI: ami-1c002379
        us-east-1:
            AMI: ami-9eb4b1e5
        us-west-2:
            AMI: ami-1d668865
        us-west-1:
            AMI: ami-4a2c192a
        eu-west-2:
            AMI: ami-cb1101af
        eu-west-1:
            AMI: ami-8fcc32f6
        eu-central-1:
            AMI: ami-0460cb6b
        ap-northeast-1:
            AMI: ami-b743bed1
        ap-southeast-2:
            AMI: ami-c1a6bda2
        ap-southeast-1:
            AMI: ami-9d1f7efe
        ca-central-1:
            AMI: ami-b677c9d2

Resources:
    ECSCluster:
        Type: AWS::ECS::Cluster
        Properties:
            ClusterName: !Ref EnvironmentName
    ECR:
        Type: AWS::ECR::Repository

    LoadBalancer:
        Type: AWS::ElasticLoadBalancingV2::LoadBalancer
        Properties:
            Name: !Ref EnvironmentName
            Tags:
                - Key: Name
                  Value: !Ref EnvironmentName

    LoadBalancerListenerHTTP:
        Type: AWS::ElasticLoadBalancingV2::Listener
        Properties:
            LoadBalancerArn: !Ref LoadBalancer
            Port: 80
            Protocol: HTTP
            DefaultActions:
                - Type: forward
                  TargetGroupArn: !Ref DefaultTargetGroup

    LoadBalancerListenerHTTPS:
        Type: AWS::ElasticLoadBalancingV2::Listener
        Properties:
            LoadBalancerArn: !Ref LoadBalancer
            Port: 443
            Protocol: HTTPS
            Certificates:
                - CertificateArn: !Ref LBCertificateArn
            DefaultActions:
                - Type: forward
                  TargetGroupArn: !Ref DefaultTargetGroup

    DefaultTargetGroup:
        Type: AWS::ElasticLoadBalancingV2::TargetGroup
        Properties:
            Name: !Sub ${EnvironmentName}-default
            Port: 80
            Protocol: HTTP

Outputs:
    Cluster:
        Description: A reference to the ECS cluster
        Value: !Ref ECSCluster

    ECR:
        Description: ECR
        Value: !Ref ECR

    LoadBalancer:
        Description: A reference to the Application Load Balancer
        Value: !Ref LoadBalancer

    LoadBalancerUrl:
        Description: The URL of the ALB
        Value: !GetAtt LoadBalancer.DNSName

    ListenerHTTP:
        Description: A reference to a port 80 listener
        Value: !Ref LoadBalancerListenerHTTP

    ListenerHTTPS:
        Description: A reference to a port 443 listener
        Value: !Ref LoadBalancerListenerHTTPS